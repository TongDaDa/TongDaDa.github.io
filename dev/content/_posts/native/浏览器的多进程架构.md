---
date: '2020-6-10'
slug: 浏览器多进程架构
tags:
- native
title: 浏览器的多进程架构
author: Oliver Liu
location: Beijing;
image: https://cdn.pixabay.com/photo/2020/05/20/12/43/landscape-5196367__340.jpg
meta:
  - name: title
    content: 浏览器的多进程架构
  - name: description
    content: 浏览器的多进程架构
  - name: keywords
    content: 
  - name: author
    content: 刘彤, Oliver Liu
  - name: language
    content: Chinese
featured: false
---

此篇文章中所述的内容，未经过源码级的考核，像webpack一样，没有绝对的教材，对频繁改版的chromium也是如此，以下仅凭个人的一些思考，实践，参阅，推导出来的，
所以，内容有可能并不完全正确，能如果拿去吹牛逼的话，后果概不负责哦😏。

此篇内容主要参考Webkit架构，早期的开源世界中，它被Apple创造出来，之后Google投入大量人力开发融入Webkit，熟悉webkit代码，
几年后，Google开发者们在这个项目中的提交占了大一半的数量，他们另起了Blink内核, 由于也是开源的，webkit也从blink上拿了一些代码，修些小bug，
但后来chrome就开始自己搞多进程架构，重构之后，Webkit开发团队一看，改动太多(由于webkit是浏览器大风起时最流行的浏览器内核，很多
厂商都基于它开发，所以不适合做大的变动)，不能抄了，结果自己就搞了一个多进程架构(效果并不理想)，并更名为Webkit2。

--- 

在多进程架构出现之前，浏览器的每个tab都是揉在一起的，这导致如果一个tab中的页面出现了未知错误，如果内部出现一个uncaughtError，整个
浏览器就有可能全退了，用户需要再次打开浏览器。对于浏览器软件架构的设计理念 -- `速度`，`安全`，`稳定`，`易用`，是极其不符的，因为
如果出现了安全漏洞所有渲染进程都是一条绳上的蚂蚱，很不稳定。

出于以上原因，Chromium从应用的视角变成了平台，技术架构也随之发生了改变，他们把一部分任务分摊开，如果是render进程出现的错误，
则在对应的tab上弹出一个页面崩溃的提示，点击确定之后，此tab就会消失，也就是对应的渲染进程。所以对于用户体验来说，多进程架构是有好的，
可行的。如图

![clipboard.png](../../../assets/chromium_principle/two.png)

一个 Browser 进程，和若干个render进程(上图示例为两个)，render进程就是我们在浏览器中打开的tab，所以render进程和tab是一一对应的关系。

这完全符合平台化的chromium设计，把每个渲染进程，也就是用户(开发者)的脚本运行的环境，打造成一个沙盒，这里所有涉及网络安全和本地存储等
安全风险较大的模块，全部通过IPC发送给Browser进程去处理。而每个渲染进程中主要有两个线程，IO线程和主线程，主线程我们不陌生，
IO线程主要与Browser进程通讯。下面先介绍这两个进程中的几个线程。

**简要和通俗的概述一下线程和进程之间的关系**，进程是cpu执行一次任务的最小单元，但一个进程是有上下文的，也不可能只让cpu执行一次，所以cpu多次执行时，进程需要保存此程序的上下文，等待下次执行。而进程从我们
单纯的"提高计算力"维度来说是过于庞大的，因为每次都需要保存上下文，等待下一次cpu的宠幸，这时，一些系统就开放了一个线程的概念，线程不用保存这个上下文，并且寄存在进程中，线程中能够很容易的互相通讯，
而且还可以让cpu执行它的任务。所以总结来说，进程和线程都是一个时间段的描述，是CPU工作时间段的描述，不过是颗粒大小不同。

## Render Process

### Main/Rendering thread -- Webkit/Blink thread

Render 线程主要负责渲染DOM树(包括整合CSSOM,composition等操作)，

### IO thread

## Browser Process

### Main thread

### IO thread

## GPU Process

文献：

- [Explore the Magic Behind Google Chrome](https://medium.com/@zicodeng/explore-the-magic-behind-google-chrome-c3563dbd2739)
- [38页的谷歌进程架构概述漫画](https://www.google.com/googlebooks/chrome/big_00.html)
